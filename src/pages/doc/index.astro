---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';

const SITE_TITLE = 'PDF Archive';
const SITE_DESCRIPTION = 'A searchable archive of public PDFs';
---

<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      main {
        width: 960px;
        margin: 0 auto;
      }
      ul {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        list-style: none;
        margin: 0;
        padding: 0;
      }
      ul li {
        width: calc(50% - 1rem);
        position: relative;
      }
      ul li a {
        display: block;
        text-decoration: none;
        color: inherit;
      }
      h3 {
        margin: 0 0 0.3rem 0;
        font-size: 1.2rem;
        color: rgb(0,0,0);
      }
      .date {
        margin: 0;
        color: rgb(128,128,128);
        font-size: 0.85rem;
      }
      .desc.truncated {
        margin: 0 0 0.3rem 0;
        color: rgb(128,128,128);
        font-size: 0.95rem;
      }
      @media (max-width: 720px) {
        ul li {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    <main>
      <h1>Document Archive</h1>

      <script type="module">
        import { onMount } from 'astro/client';

        let pdfs = [];
        let container = null;

        onMount(async () => {
          try {
            const res = await fetch('https://pdf-archive.alexgshijan.workers.dev/api/pdfs?ts=' + Date.now());
            if (!res.ok) throw new Error('Failed to fetch PDFs');
            pdfs = await res.json();
            pdfs.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

            const ul = document.createElement('ul');
            pdfs.forEach(pdf => {
              const li = document.createElement('li');
              li.style.width = 'calc(50% - 1rem)';
              li.style.position = 'relative';

              const a = document.createElement('a');
              a.href = `/doc/${pdf.filename}/`;
              a.title = pdf.description;
              a.style.display = 'block';
              a.style.textDecoration = 'none';
              a.style.color = 'inherit';

              const h3 = document.createElement('h3');
              h3.textContent = pdf.title;
              h3.style.margin = '0 0 0.3rem 0';
              h3.style.fontSize = '1.2rem';
              h3.style.color = 'rgb(0,0,0)';

              const pDesc = document.createElement('p');
              pDesc.textContent = pdf.description.length > 70 ? pdf.description.slice(0, 67) + '…' : pdf.description;
              pDesc.style.margin = '0 0 0.3rem 0';
              pDesc.style.color = 'rgb(128,128,128)';
              pDesc.style.fontSize = '0.95rem';

              const pDate = document.createElement('p');
              pDate.style.margin = '0';
              pDate.style.color = 'rgb(128,128,128)';
              pDate.style.fontSize = '0.85rem';
              const date = new Date(pdf.pubDate);
              pDate.textContent = date.toLocaleDateString();

              a.appendChild(h3);
              a.appendChild(pDesc);
              a.appendChild(pDate);
              li.appendChild(a);
              ul.appendChild(li);
            });

            container.innerHTML = '';
            container.appendChild(ul);
          } catch (e) {
            container.textContent = 'Failed to load PDFs.';
            console.error(e);
          }
        });
      </script>

      <div id="pdf-container" ref={el => container = el}>
        Loading PDFs…
      </div>

    </main>
    <Footer />
  </body>
</html>